<script lang="ts">
    import { goto } from "@sapper/app";
    import Cookies from "js-cookie";
    import SvgDashboard from "client/svg/Dashboard.svelte";
    import SvgLines from "client/svg/Lines.svelte";
    import SvgLogout from "client/svg/Logout.svelte";
    import SvgItem from "client/svg/Item.svelte";
    import SvgTransaction from "client/svg/Transaction.svelte";
    import SvgUser from "client/svg/User.svelte";
    import { onMount } from "svelte";

    let collapsed = Cookies.get("sidebarCollapsed") !== undefined;
    const token = Cookies.get("token");

    let hasSession = false;

    onMount(() => {
        if (token) {
            fetch("/session/check", {
                headers: {
                    Authorization: token,
                },
            }).then((res) => {
                if (res.status == 401) {
                    goto("/session/login");
                } else {
                    hasSession = true;
                }
            });
        } else {
            fetch("/session/logout");
            Cookies.remove("token");
            goto("/session/login");
        }
    });

    function collapse() {
        collapsed = !collapsed;

        // save to cookie so the state is saved and accessible between page
        // since we only need a boolean, just remove it and check if it's present lmao
        collapsed ? Cookies.set("sidebarCollapsed", "") : Cookies.remove("sidebarCollapsed");
    }

    function logout() {
        Cookies.remove("token");
        goto("/session/login");
    }

    export let pageName: string;
</script>

<svelte:head>
    <title>{pageName}</title>
</svelte:head>

<!-- hide the page until it determined whether the session is valid or not -->
{#if hasSession}
    <div class="animate-load">
        <!-- sidebar -->
        <div
            class="transition ease-out duration-700 transform fixed left-0 flex flex-col w-48 bg-gray-900 h-full text-gray-200"
            class:-translate-x-32={collapsed}>
            <button
                class="w-full flex px-5 py-3 space-x-4 focus:outline-none hover:bg-gray-600"
                type="button"
                on:click={collapse}>
                <div class="transition ease-out duration-700 transform" class:translate-x-32={collapsed}>
                    <SvgLines />
                </div>
                <div class="transition ease-in-out duration-1000" class:opacity-0={collapsed}>Collapse</div>
            </button>
            <div class="flex-grow" />
            <button
                class="w-full flex px-5 py-3 space-x-4 focus:outline-none hover:bg-gray-600"
                type="button"
                on:click={() => goto("/dashboard")}>
                <div class="transition ease-out duration-700 transform" class:translate-x-32={collapsed}>
                    <SvgDashboard />
                </div>
                <div class="transition ease-in-out duration-1000" class:opacity-0={collapsed}>Dashboard</div>
            </button>
            <button
                class="w-full flex px-5 py-3 space-x-4 focus:outline-none hover:bg-gray-600"
                type="button"
                on:click={() => goto("/item")}>
                <div class="transition ease-out duration-700 transform" class:translate-x-32={collapsed}>
                    <SvgItem />
                </div>
                <div class="transition ease-in-out duration-1000" class:opacity-0={collapsed}>Items</div>
            </button>
            <button
                class="w-full flex px-5 py-3 space-x-4 focus:outline-none hover:bg-gray-600"
                type="button"
                on:click={() => goto("/customer")}>
                <div class="transition ease-out duration-700 transform" class:translate-x-32={collapsed}>
                    <SvgUser />
                </div>
                <div class="transition ease-in-out duration-1000" class:opacity-0={collapsed}>Customers</div>
            </button>
            <button
                class="w-full flex px-5 py-3 space-x-4 focus:outline-none hover:bg-gray-600"
                type="button"
                on:click={() => goto("/transaction")}>
                <div class="transition ease-out duration-700 transform" class:translate-x-32={collapsed}>
                    <SvgTransaction />
                </div>
                <div class="transition ease-in-out duration-1000" class:opacity-0={collapsed}>Transactions</div>
            </button>
            <div class="flex-grow" />
            <button
                class="w-full flex px-5 py-3 space-x-4 focus:outline-none text-red-500 hover:bg-red-600 hover:text-white"
                type="button"
                on:click={logout}>
                <div class="transition-transform ease-out duration-700 transform" class:translate-x-32={collapsed}>
                    <SvgLogout />
                </div>
                <div class="transition-opacity ease-in-out duration-1000" class:opacity-0={collapsed}>Logout</div>
            </button>
        </div>

        <!-- content -->
        <div class="transition-spacing ease-out duration-700 pl-{collapsed ? 16 : 48} bg-gray-800 text-gray-200">
            <div class="flex px-3 pt-3 align-bottom">
                <div class="text-3xl font-bold flex-grow">{pageName}</div>
                <div class="flex items-end font-mono text-gray-600 hover:text-blue-800 pb-2">
                    <!-- shameless plug -->
                    <a href="https://github.com/badasintended/ukk">@badasintended/ukk</a>
                </div>
            </div>
            <div class="bg-gray-200 text-gray-900">
                <slot />
            </div>
        </div>
    </div>
{/if}
